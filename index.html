<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owen's Docs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond&family=JetBrains+Mono&family=Inter:wght@400;700&family=Roboto+Slab&family=Caveat:wght@700&display=swap');
        
        #login-screen { transition: opacity 0.3s; }
        .hidden-fade { opacity: 0; pointer-events: none; }
        
        #edit-content { min-height: 600px; outline: none; line-height: 1.6; position: relative; }
        #edit-content a { color: #2563eb; text-decoration: underline; }

        /* Image Resizing */
        .resizable-img { position: relative; display: inline-block; margin: 15px 0; line-height: 0; cursor: default; }
        .resizable-img img { width: 100%; height: auto; border-radius: 8px; display: block; pointer-events: none; }
        .resizable-img.selected { outline: 3px solid #3b82f6; }
        .resize-handle { 
            position: absolute; bottom: -8px; right: -8px; width: 16px; height: 16px; 
            background: #3b82f6; border-radius: 50%; cursor: nwse-resize; display: none; z-index: 10;
        }
        .selected .resize-handle { display: block; }

        /* Font Styles */
        .font-sans { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'EB Garamond', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-slab { font-family: 'Roboto Slab', serif; }
        .font-hand { font-family: 'Caveat', cursive; font-size: 1.4rem; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans overflow-x-hidden">

    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] flex flex-col gap-2"></div>
    <input type="file" id="image-input" accept="image/*" class="hidden">

    <div id="login-screen" class="fixed inset-0 bg-white z-[70] flex flex-col items-center justify-center">
        <h1 class="text-4xl font-bold text-slate-800 mb-6 italic tracking-tighter">Owen's Docs</h1>
        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3 rounded-2xl font-bold shadow-xl active:scale-95 transition-all">
            <i class="fab fa-google mr-2"></i> Sign in with Google
        </button>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-2"></h3>
            <p id="modal-desc" class="text-slate-500 text-sm mb-6"></p>
            <input id="modal-input" type="text" class="hidden w-full p-4 border rounded-xl mb-6 outline-none focus:ring-2 ring-blue-500" placeholder="Paste link here...">
            <div class="flex gap-4 justify-end">
                <button id="modal-cancel" class="text-slate-400 font-bold text-sm">Cancel</button>
                <button id="modal-confirm" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <nav id="main-nav" class="hidden bg-white border-b px-8 py-4 flex justify-between items-center sticky top-0 z-10">
        <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Owen's Library</h2>
        <button id="logout-btn" class="text-red-500 font-black text-[10px] tracking-widest uppercase">Logout</button>
    </nav>

    <main id="dashboard" class="hidden max-w-6xl mx-auto p-8">
        <div class="flex justify-between items-center mb-12">
            <h3 class="text-3xl font-bold text-slate-900">Documents</h3>
            <button id="create-btn" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-blue-200 transition-all">
                <i class="fas fa-plus mr-2"></i> New
            </button>
        </div>
        <div id="docs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </main>

    <div id="editor-modal" class="fixed inset-0 bg-white hidden z-[60] flex flex-col">
        <div id="status-bar" class="bg-slate-900 text-white px-6 py-1.5 text-[9px] font-black uppercase tracking-widest text-center"></div>

        <div class="p-4 border-b flex justify-between items-center bg-white shadow-sm">
            <div class="flex items-center gap-4 w-full">
                <button id="close-editor" class="text-slate-400 hover:text-slate-900 text-xl px-2"><i class="fas fa-arrow-left"></i></button>
                <input id="edit-title" type="text" class="text-xl font-bold outline-none w-full border-none" placeholder="Untitled">
            </div>
            <div class="flex items-center gap-6">
                <div id="save-indicator" class="text-[9px] font-black text-slate-400">SAVED</div>
                <button id="export-pdf-btn" class="bg-slate-100 hover:bg-slate-200 px-5 py-2 rounded-xl text-xs font-bold text-slate-700 transition">PDF</button>
            </div>
        </div>

        <div id="admin-toolbar" class="hidden bg-slate-50 border-b p-2 flex flex-wrap gap-2 justify-center sticky top-0 z-20">
            <select id="font-select" class="text-xs font-bold border rounded-lg px-3 bg-white outline-none">
                <option value="font-sans">Modern Sans</option>
                <option value="font-serif">Classic Serif</option>
                <option value="font-mono">Mono Code</option>
                <option value="font-slab">Roboto Slab</option>
                <option value="font-hand">Handwritten</option>
            </select>
            <div class="w-px h-6 bg-slate-200 mx-2"></div>
            <button onclick="document.execCommand('bold')" class="p-2 hover:bg-slate-200 rounded-lg"><i class="fas fa-bold"></i></button>
            <button onclick="document.execCommand('italic')" class="p-2 hover:bg-slate-200 rounded-lg"><i class="fas fa-italic"></i></button>
            <button id="btn-link" class="p-2 hover:bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-link"></i></button>
            <button id="btn-image" class="p-2 hover:bg-emerald-50 text-emerald-600 rounded-lg"><i class="fas fa-image"></i> Image</button>
        </div>

        <div class="flex-1 overflow-y-auto bg-white" id="editor-container">
            <div id="edit-content" contenteditable="true" class="max-w-4xl mx-auto p-12 md:p-24 outline-none"></div>
        </div>

        <div id="editor-footer" class="p-4 border-t flex justify-between items-center bg-slate-50 px-8">
            <div id="admin-actions" class="hidden flex gap-4">
                <div class="relative group">
                    <button id="share-menu-btn" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-xs font-bold uppercase tracking-widest shadow-md">Access</button>
                    <div id="share-dropdown" class="hidden absolute bottom-full mb-3 left-0 w-64 bg-white border border-slate-100 shadow-2xl rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-xs font-black uppercase text-slate-400">Public Link</span>
                            <input type="checkbox" id="public-toggle" class="w-5 h-5 accent-blue-600">
                        </div>
                        <button id="copy-link-btn" class="hidden w-full bg-blue-50 text-blue-600 text-[10px] py-3 rounded-xl font-black uppercase tracking-tighter border border-blue-100">Copy Link</button>
                    </div>
                </div>
                <button id="delete-btn-trigger" class="text-slate-300 hover:text-red-500 p-2 transition"><i class="fas fa-trash-can"></i></button>
            </div>
            <div id="word-count" class="text-[9px] font-black text-slate-400 uppercase tracking-widest">0 Words</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDqnZfCWAwU7KXJEGunzYAP5qfZJQVvExQ",
            authDomain: "imcrabpd.firebaseapp.com",
            databaseURL: "https://imcrabpd-default-rtdb.firebaseio.com",
            projectId: "imcrabpd",
            storageBucket: "imcrabpd.firebasestorage.app",
            messagingSenderId: "555027239107",
            appId: "1:555027239107:web:d4d58affb9b3dea996d276"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = 'imcrabfr@gmail.com';
        let currentDocId = null;
        let currentUnsub = null;
        let isTyping = false;
        let saveTimer = null;

        // --- Custom Logic ---
        function showToast(m) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = "bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl text-[10px] font-black uppercase";
            t.innerText = m;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function openModal(title, desc, input, onConfirm) {
            const m = document.getElementById('custom-modal');
            const i = document.getElementById('modal-input');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            i.classList.toggle('hidden', !input);
            m.classList.remove('hidden');
            document.getElementById('modal-confirm').onclick = () => { onConfirm(i.value); m.classList.add('hidden'); };
            document.getElementById('modal-cancel').onclick = () => m.classList.add('hidden');
        }

        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            const urlDocId = new URLSearchParams(window.location.search).get('doc');
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('login-screen').classList.add('hidden-fade');
                document.getElementById('main-nav').classList.remove('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadDashboard();
                if (urlDocId) loadDoc(urlDocId);
            } else if (urlDocId) {
                loadDoc(urlDocId);
            } else {
                if (user) signOut(auth);
                document.getElementById('login-screen').classList.remove('hidden-fade');
            }
        });

        function loadDoc(id) {
            // open editor and let the realtime listener populate content
            get(ref(db, `docs/${id}`)).then(s => {
                const d = s.val();
                if (d && (d.publicView || (auth.currentUser && d.owner === ADMIN_EMAIL))) {
                    openEditor(id, d);
                    document.getElementById('login-screen').classList.add('hidden-fade');
                }
            });
        }

        function loadDashboard() {
            onValue(ref(db, 'docs'), (s) => {
                const grid = document.getElementById('docs-grid');
                grid.innerHTML = '';
                const data = s.val();
                for (let id in data) {
                    if (data[id].owner === ADMIN_EMAIL) {
                        const card = document.createElement('div');
                        card.className = "bg-white p-8 rounded-3xl border border-slate-100 hover:border-blue-500 cursor-pointer shadow-sm hover:shadow-xl transition-all";
                        card.innerHTML = `<h4 class="font-bold truncate text-slate-800">${data[id].title || 'Untitled'}</h4>`;
                        card.onclick = () => openEditor(id, data[id]);
                        grid.appendChild(card);
                    }
                }
            });
        }

        function openEditor(id, data) {
            currentDocId = id;
            document.getElementById('edit-title').value = data.title;
            document.getElementById('edit-content').innerHTML = data.content || '';
            
            const isOwner = auth.currentUser && auth.currentUser.email === ADMIN_EMAIL;
            document.getElementById('edit-content').contentEditable = isOwner;
            document.getElementById('admin-toolbar').classList.toggle('hidden', !isOwner);
            document.getElementById('admin-actions').classList.toggle('hidden', !isOwner);
            document.getElementById('close-editor').classList.toggle('hidden', !isOwner);
            
            document.getElementById('status-bar').innerText = isOwner ? "Editing: OWNER" : "Viewing: GUEST";
            document.getElementById('status-bar').className = isOwner ? "bg-blue-600 text-white px-6 py-1.5 text-[9px] font-black uppercase tracking-widest text-center" : "bg-slate-800 text-white px-6 py-1.5 text-[9px] font-black uppercase tracking-widest text-center";

            document.getElementById('public-toggle').checked = !!data.publicView;
            document.getElementById('copy-link-btn').classList.toggle('hidden', !data.publicView);
            
            document.getElementById('edit-content').className = `max-w-4xl mx-auto p-12 md:p-24 outline-none ${data.fontClass || 'font-sans'}`;
            document.getElementById('font-select').value = data.fontClass || 'font-sans';
            
            document.getElementById('editor-modal').classList.remove('hidden');
            attachImageListeners();
            // detach previous listener
            if (currentUnsub) currentUnsub();
            // subscribe to realtime updates for this document
            currentUnsub = onValue(ref(db, `docs/${id}`), (snap) => {
                const d = snap.val();
                if (!d) return;
                // update UI fields
                document.getElementById('edit-title').value = d.title || '';
                document.getElementById('font-select').value = d.fontClass || 'font-sans';
                document.getElementById('edit-content').className = `max-w-4xl mx-auto p-12 md:p-24 outline-none ${d.fontClass || 'font-sans'}`;
                document.getElementById('public-toggle').checked = !!d.publicView;
                document.getElementById('copy-link-btn').classList.toggle('hidden', !d.publicView);
                // if remote change and user not actively typing, apply it
                if (!isTyping && d.content != document.getElementById('edit-content').innerHTML) {
                    document.getElementById('edit-content').innerHTML = d.content || '';
                    updateCount();
                    attachImageListeners();
                }
            });
        }

        const save = () => {
            if (!currentDocId || !auth.currentUser) return;
            document.getElementById('save-indicator').innerText = "SAVING...";
            const payload = {
                title: document.getElementById('edit-title').value,
                content: document.getElementById('edit-content').innerHTML,
                fontClass: document.getElementById('font-select').value,
                lastUpdatedAt: Date.now(),
                lastUpdatedBy: auth.currentUser ? auth.currentUser.uid : null
            };
            update(ref(db, `docs/${currentDocId}`), payload).then(() => {
                document.getElementById('save-indicator').innerText = "SAVED";
                updateCount();
            });
        };

        // --- Multimedia Features ---
        document.getElementById('btn-image').onclick = () => document.getElementById('image-input').click();
        document.getElementById('image-input').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const html = `<div class="resizable-img" contenteditable="false"><img src="${ev.target.result}"><div class="resize-handle"></div></div><p><br></p>`;
                    document.getElementById('edit-content').focus();
                    document.execCommand('insertHTML', false, html);
                    attachImageListeners();
                    save();
                };
                reader.readAsDataURL(file);
            }
        };

        function attachImageListeners() {
            document.querySelectorAll('.resizable-img').forEach(wrap => {
                wrap.onmousedown = (e) => {
                    document.querySelectorAll('.resizable-img').forEach(el => el.classList.remove('selected'));
                    wrap.classList.add('selected');
                    if (e.target.classList.contains('resize-handle')) {
                        e.preventDefault();
                        const startX = e.clientX;
                        const startW = wrap.offsetWidth;
                        const onMove = (mv) => { wrap.style.width = (startW + (mv.clientX - startX)) + 'px'; };
                        const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); save(); };
                        document.addEventListener('mousemove', onMove);
                        document.addEventListener('mouseup', onUp);
                    }
                };
            });
        }

        document.getElementById('btn-link').onclick = () => {
            openModal("Add Link", "Enter the URL (e.g., https://google.com)", true, (v) => {
                if (v) document.execCommand('createLink', false, v);
            });
        };

        function updateCount() {
            const txt = document.getElementById('edit-content').innerText;
            const words = txt.trim() ? txt.trim().split(/\s+/).length : 0;
            document.getElementById('word-count').innerText = `${words} Words`;
        }

        // --- Controls ---
        document.getElementById('edit-content').addEventListener('input', () => {
            isTyping = true;
            updateCount();
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => { save(); isTyping = false; }, 1200);
        });
        document.getElementById('edit-title').addEventListener('input', () => {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(save, 800);
        });
        document.getElementById('font-select').onchange = (e) => {
            document.getElementById('edit-content').className = `max-w-4xl mx-auto p-12 md:p-24 outline-none ${e.target.value}`;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(save, 400);
        };

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.reload());
        document.getElementById('close-editor').onclick = () => { document.getElementById('editor-modal').classList.add('hidden'); window.history.replaceState({}, '', window.location.pathname); };
        document.getElementById('create-btn').onclick = () => {
            const n = push(ref(db, 'docs'));
            const d = { title: "New Doc", content: "", owner: ADMIN_EMAIL, fontClass: 'font-sans', publicView: false };
            set(n, d).then(() => openEditor(n.key, d));
        };
        document.getElementById('export-pdf-btn').onclick = () => {
            showToast("Generating PDF...");
            html2pdf().from(document.getElementById('edit-content')).save(`${document.getElementById('edit-title').value}.pdf`);
        };
        document.getElementById('share-menu-btn').onclick = (e) => { e.stopPropagation(); document.getElementById('share-dropdown').classList.toggle('hidden'); };
        // top share button (prominent)
        const topShareBtn = document.createElement('button');
        topShareBtn.id = 'top-share-btn';
        topShareBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold';
        topShareBtn.innerText = 'Share';
        // insert into header area next to PDF export
        document.getElementById('export-pdf-btn').parentNode.insertBefore(topShareBtn, document.getElementById('export-pdf-btn'));
        topShareBtn.onclick = (e) => { e.stopPropagation(); document.getElementById('share-dropdown').classList.toggle('hidden'); };
        document.getElementById('public-toggle').onchange = (e) => {
            update(ref(db, `docs/${currentDocId}`), { publicView: e.target.checked });
            document.getElementById('copy-link-btn').classList.toggle('hidden', !e.target.checked);
            showToast("Permissions updated");
        };
        document.getElementById('copy-link-btn').onclick = () => {
            const link = `${window.location.origin}${window.location.pathname}?doc=${currentDocId}`;
            navigator.clipboard.writeText(link);
            if (!document.getElementById('public-toggle').checked) {
                showToast("Link copied. Toggle Public to allow viewing.");
            } else {
                showToast("Link copied!");
            }
        };
        document.getElementById('delete-btn-trigger').onclick = () => {
            openModal("Delete Document?", "This cannot be undone.", false, () => {
                remove(ref(db, `docs/${currentDocId}`));
                document.getElementById('editor-modal').classList.add('hidden');
                showToast("Deleted");
            });
        };

        window.addEventListener('click', (e) => {
            document.getElementById('share-dropdown').classList.add('hidden');
            if (!e.target.closest('.resizable-img')) document.querySelectorAll('.resizable-img').forEach(el => el.classList.remove('selected'));
        });
        document.getElementById('share-dropdown').onclick = (e) => e.stopPropagation();
    </script>
</body>
</html>